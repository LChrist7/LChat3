rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏
    match /users/{userId} {
      allow read: if request.auth != null;
      allow write: if request.auth != null && request.auth.uid == userId;
      
      // FCM —Ç–æ–∫–µ–Ω—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
      match /tokens/{tokenId} {
        allow read, write: if request.auth != null && request.auth.uid == userId;
        allow delete: if request.auth != null && request.auth.uid == userId;
      }
    }
    
    // –ß–∞—Ç—ã
    match /chats/{chatId} {
      allow read: if request.auth != null && 
                     request.auth.uid in resource.data.participants;
      allow create: if request.auth != null;
      allow update: if request.auth != null && 
                       request.auth.uid in resource.data.participants;
      
      // –°–æ–æ–±—â–µ–Ω–∏—è –≤–Ω—É—Ç—Ä–∏ —á–∞—Ç–æ–≤
      match /messages/{messageId} {
        allow read: if request.auth != null &&
                       request.auth.uid in get(/databases/$(database)/documents/chats/$(chatId)).data.participants;
        allow create: if request.auth != null &&
                         request.auth.uid in get(/databases/$(database)/documents/chats/$(chatId)).data.participants;
      }
      
      // –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä –ø–µ—á–∞—Ç–∞–Ω–∏—è
      match /typing/{statusId} {
        allow read: if request.auth != null &&
                       request.auth.uid in get(/databases/$(database)/documents/chats/$(chatId)).data.participants;
        allow write: if request.auth != null &&
                        request.auth.uid in get(/databases/$(database)/documents/chats/$(chatId)).data.participants;
      }
    }
    
    // üìû –ó–í–û–ù–ö–ò (–ù–û–í–û–ï)
    match /calls/{callId} {
      // –ß–∏—Ç–∞—Ç—å –º–æ–≥—É—Ç —Ç–æ–ª—å–∫–æ —É—á–∞—Å—Ç–Ω–∏–∫–∏ –∑–≤–æ–Ω–∫–∞
      allow read: if request.auth != null &&
                     (request.auth.uid == resource.data.callerId ||
                      request.auth.uid == resource.data.recipientId);
      
      // –°–æ–∑–¥–∞–≤–∞—Ç—å –º–æ–∂–µ—Ç —Ç–æ–ª—å–∫–æ –∑–≤–æ–Ω—è—â–∏–π
      allow create: if request.auth != null &&
                       request.auth.uid == request.resource.data.callerId;
      
      // –û–±–Ω–æ–≤–ª—è—Ç—å –º–æ–≥—É—Ç –æ–±–∞ —É—á–∞—Å—Ç–Ω–∏–∫–∞
      allow update: if request.auth != null &&
                       (request.auth.uid == resource.data.callerId ||
                        request.auth.uid == resource.data.recipientId);
      
      // –£–¥–∞–ª—è—Ç—å –º–æ–∂–µ—Ç –ª—é–±–æ–π —É—á–∞—Å—Ç–Ω–∏–∫
      allow delete: if request.auth != null &&
                       (request.auth.uid == resource.data.callerId ||
                        request.auth.uid == resource.data.recipientId);
    }
  }
}
