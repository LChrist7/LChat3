<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Мессенджер</title>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;

        // Firebase конфигурация
        const FIREBASE_CONFIG = {
            apiKey: "AIzaSyD-JW_GPcXYE6Mo87wKDAKKtRSwIGzLp5g",
            authDomain: "lchat3-7ad86.firebaseapp.com",
            projectId: "lchat3-7ad86",
            storageBucket: "lchat3-7ad86.firebasestorage.app",
            messagingSenderId: "956958925747",
            appId: "1:956958925747:web:966a2906f540538251a1c6"
        };

        // Глобальное хранилище Firebase
        const Firebase = {
            auth: null,
            db: null,
            functions: null,
            initialized: false
        };

        // Инициализация Firebase
        async function initFirebase() {
            if (Firebase.initialized) return;
            
            try {
                console.log('Начинаем инициализацию Firebase...');
                
                const { initializeApp } = await import('https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js');
                const { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged } = 
                    await import('https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js');
                const { getFirestore, doc, setDoc, getDoc } = 
                    await import('https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js');
                
                console.log('Firebase модули загружены');
                
                const app = initializeApp(FIREBASE_CONFIG);
                Firebase.auth = getAuth(app);
                Firebase.db = getFirestore(app);
                Firebase.functions = { 
                    createUserWithEmailAndPassword, 
                    signInWithEmailAndPassword, 
                    signOut, 
                    onAuthStateChanged,
                    doc, 
                    setDoc, 
                    getDoc 
                };
                
                Firebase.initialized = true;
                console.log('✅ Firebase успешно инициализирован');
            } catch (error) {
                console.error('❌ Ошибка инициализации Firebase:', error);
                Firebase.initialized = false;
                throw error;
            }
        }

        // Конвертация логина в email для Firebase
        function loginToEmail(login) {
            return `${login.toLowerCase()}@messenger.local`;
        }

        function App() {
            const [isLogin, setIsLogin] = useState(true);
            const [login, setLogin] = useState('');
            const [password, setPassword] = useState('');
            const [user, setUser] = useState(null);
            const [error, setError] = useState('');
            const [loading, setLoading] = useState(false);
            const [initializing, setInitializing] = useState(true);

            // Инициализация Firebase при загрузке
            useEffect(() => {
                let unsubscribe = null;
                
                initFirebase()
                    .then(() => {
                        console.log('Firebase готов, настраиваем слушатель авторизации...');
                        const { onAuthStateChanged, doc, getDoc } = Firebase.functions;
                        
                        unsubscribe = onAuthStateChanged(Firebase.auth, async (firebaseUser) => {
                            console.log('Состояние авторизации:', firebaseUser ? 'Авторизован' : 'Нет');
                            
                            if (firebaseUser) {
                                try {
                                    const userDoc = await getDoc(doc(Firebase.db, 'users', firebaseUser.uid));
                                    
                                    if (userDoc.exists()) {
                                        setUser({
                                            uid: firebaseUser.uid,
                                            login: userDoc.data().login
                                        });
                                        console.log('Данные пользователя загружены');
                                    }
                                } catch (error) {
                                    console.error('Ошибка загрузки данных:', error);
                                }
                            } else {
                                setUser(null);
                            }
                            setInitializing(false);
                        });
                    })
                    .catch((err) => {
                        console.error('Ошибка инициализации:', err);
                        setError('Ошибка подключения к Firebase');
                        setInitializing(false);
                    });
                
                return () => {
                    if (unsubscribe) unsubscribe();
                };
            }, []);

            // Авторизация через Firebase
            const handleAuth = async () => {
                setError('');
                setLoading(true);

                try {
                    if (!Firebase.initialized || !Firebase.functions) {
                        throw new Error('Firebase еще не инициализирован');
                    }

                    if (!login || !password) {
                        throw new Error('Заполните все поля');
                    }
                    
                    if (login.length < 3) {
                        throw new Error('Логин должен быть не менее 3 символов');
                    }

                    if (password.length < 6) {
                        throw new Error('Пароль должен быть не менее 6 символов');
                    }

                    const email = loginToEmail(login);
                    const { createUserWithEmailAndPassword, signInWithEmailAndPassword, doc, setDoc, getDoc } = Firebase.functions;

                    if (isLogin) {
                        const userCredential = await signInWithEmailAndPassword(Firebase.auth, email, password);
                        const userDoc = await getDoc(doc(Firebase.db, 'users', userCredential.user.uid));
                        
                        setUser({
                            uid: userCredential.user.uid,
                            login: userDoc.data().login
                        });
                    } else {
                        const userCredential = await createUserWithEmailAndPassword(Firebase.auth, email, password);
                        
                        await setDoc(doc(Firebase.db, 'users', userCredential.user.uid), {
                            login: login,
                            createdAt: new Date().toISOString()
                        });
                        
                        setUser({
                            uid: userCredential.user.uid,
                            login: login
                        });
                    }

                    setLoading(false);
                } catch (err) {
                    console.error('Ошибка авторизации:', err);
                    
                    let errorMessage = 'Произошла ошибка';
                    
                    if (err.code === 'auth/email-already-in-use') {
                        errorMessage = 'Этот логин уже занят';
                    } else if (err.code === 'auth/wrong-password' || err.code === 'auth/user-not-found') {
                        errorMessage = 'Неверный логин или пароль';
                    } else if (err.code === 'auth/invalid-credential') {
                        errorMessage = 'Неверный логин или пароль';
                    } else if (err.message) {
                        errorMessage = err.message;
                    }
                    
                    setError(errorMessage);
                    setLoading(false);
                }
            };

            const handleLogout = async () => {
                try {
                    const { signOut } = Firebase.functions;
                    await signOut(Firebase.auth);
                    setUser(null);
                    setLogin('');
                    setPassword('');
                } catch (err) {
                    console.error('Ошибка выхода:', err);
                }
            };

            const handleKeyPress = (e) => {
                if (e.key === 'Enter') {
                    handleAuth();
                }
            };

            // Экран загрузки
            if (initializing) {
                return (
                    <div className="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 flex items-center justify-center p-4">
                        <div className="bg-white rounded-2xl shadow-xl p-8 w-full max-w-md text-center">
                            <div className="w-16 h-16 bg-indigo-600 rounded-full flex items-center justify-center mx-auto mb-4 animate-pulse">
                                <svg className="w-8 h-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z" />
                                </svg>
                            </div>
                            <p className="text-gray-600 mb-4">Подключение к Firebase...</p>
                            {error && (
                                <div className="bg-red-50 border border-red-200 rounded-lg p-3 mt-4">
                                    <p className="text-red-800 text-sm">{error}</p>
                                </div>
                            )}
                        </div>
                    </div>
                );
            }

            // Авторизован
            if (user) {
                return (
                    <div className="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 flex items-center justify-center p-4">
                        <div className="bg-white rounded-2xl shadow-xl p-8 w-full max-w-md">
                            <div className="text-center">
                                <div className="w-20 h-20 bg-indigo-600 rounded-full flex items-center justify-center mx-auto mb-4">
                                    <span className="text-3xl text-white font-bold">
                                        {user.login.charAt(0).toUpperCase()}
                                    </span>
                                </div>
                                <h2 className="text-2xl font-bold text-gray-800 mb-2">
                                    Привет, {user.login}!
                                </h2>
                                <p className="text-gray-600 mb-6">
                                    ID: {user.uid.substring(0, 8)}...
                                </p>
                                <div className="bg-green-50 border border-green-200 rounded-lg p-4 mb-6">
                                    <p className="text-green-800 font-medium">
                                        ✅ Firebase подключен!
                                    </p>
                                    <p className="text-green-600 text-sm mt-1">
                                        Этап 2: Интерфейс чата (следующий)
                                    </p>
                                </div>
                                <button
                                    onClick={handleLogout}
                                    className="w-full bg-red-500 text-white py-3 rounded-lg font-medium hover:bg-red-600 transition-colors"
                                >
                                    Выйти
                                </button>
                            </div>
                        </div>
                    </div>
                );
            }

            // Форма авторизации
            return (
                <div className="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 flex items-center justify-center p-4">
                    <div className="bg-white rounded-2xl shadow-xl p-8 w-full max-w-md">
                        <div className="text-center mb-8">
                            <div className="w-16 h-16 bg-indigo-600 rounded-full flex items-center justify-center mx-auto mb-4">
                                <svg className="w-8 h-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z" />
                                </svg>
                            </div>
                            <h1 className="text-3xl font-bold text-gray-800 mb-2">
                                Мессенджер
                            </h1>
                            <p className="text-gray-600">
                                {isLogin ? 'Войдите в свой аккаунт' : 'Создайте новый аккаунт'}
                            </p>
                        </div>

                        <div className="flex bg-gray-100 rounded-lg p-1 mb-6">
                            <button
                                onClick={() => { setIsLogin(true); setError(''); }}
                                className={`flex-1 py-2 rounded-md font-medium transition-all ${
                                    isLogin ? 'bg-white text-indigo-600 shadow-sm' : 'text-gray-600 hover:text-gray-800'
                                }`}
                            >
                                Вход
                            </button>
                            <button
                                onClick={() => { setIsLogin(false); setError(''); }}
                                className={`flex-1 py-2 rounded-md font-medium transition-all ${
                                    !isLogin ? 'bg-white text-indigo-600 shadow-sm' : 'text-gray-600 hover:text-gray-800'
                                }`}
                            >
                                Регистрация
                            </button>
                        </div>

                        <div className="space-y-4">
                            <div>
                                <label className="block text-sm font-medium text-gray-700 mb-2">
                                    Логин
                                </label>
                                <input
                                    type="text"
                                    value={login}
                                    onChange={(e) => setLogin(e.target.value)}
                                    onKeyPress={handleKeyPress}
                                    className="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent outline-none transition-all"
                                    placeholder="Ваш логин"
                                />
                            </div>

                            <div>
                                <label className="block text-sm font-medium text-gray-700 mb-2">
                                    Пароль
                                </label>
                                <input
                                    type="password"
                                    value={password}
                                    onChange={(e) => setPassword(e.target.value)}
                                    onKeyPress={handleKeyPress}
                                    className="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent outline-none transition-all"
                                    placeholder="••••••••"
                                />
                            </div>

                            {error && (
                                <div className="bg-red-50 border border-red-200 rounded-lg p-3">
                                    <p className="text-red-800 text-sm">{error}</p>
                                </div>
                            )}

                            <button
                                onClick={handleAuth}
                                disabled={loading || !Firebase.initialized}
                                className="w-full bg-indigo-600 text-white py-3 rounded-lg font-medium hover:bg-indigo-700 transition-colors disabled:opacity-50 disabled:cursor-not-allowed"
                            >
                                {loading ? 'Загрузка...' : !Firebase.initialized ? 'Инициализация...' : (isLogin ? 'Войти' : 'Зарегистрироваться')}
                            </button>
                        </div>

                        <div className="mt-6 pt-6 border-t border-gray-200">
                            <p className="text-sm text-gray-600 text-center">
                                📍 Этап 1: Firebase подключен ✅
                            </p>
                        </div>
                    </div>
                </div>
            );
        }

        // Рендер приложения
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
