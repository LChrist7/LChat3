<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ú–µ—Å—Å–µ–Ω–¥–∂–µ—Ä</title>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js';
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js';
        import { getFirestore, doc, setDoc, getDoc } from 'https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js';
        
        const firebaseConfig = {
            apiKey: "AIzaSyD-JW_GPcXYE6Mo87wKDAKKtRSwIGzLp5g",
            authDomain: "lchat3-7ad86.firebaseapp.com",
            projectId: "lchat3-7ad86",
            storageBucket: "lchat3-7ad86.firebasestorage.app",
            messagingSenderId: "956958925747",
            appId: "1:956958925747:web:966a2906f540538251a1c6"
        };
        
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        
        // –≠–∫—Å–ø–æ—Ä—Ç–∏—Ä—É–µ–º –≤ window –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –≤ React
        window.firebaseApp = app;
        window.firebaseAuth = auth;
        window.firebaseDb = db;
        window.firebaseFunctions = {
            createUserWithEmailAndPassword,
            signInWithEmailAndPassword,
            signOut,
            onAuthStateChanged,
            doc,
            setDoc,
            getDoc
        };
        window.firebaseReady = true;
        
        console.log('‚úÖ Firebase –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω');
    </script>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;

        // –ö–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è –ª–æ–≥–∏–Ω–∞ –≤ email –¥–ª—è Firebase
        function loginToEmail(login) {
            return `${login.toLowerCase()}@messenger.local`;
        }

        function App() {
            const [isLogin, setIsLogin] = useState(true);
            const [login, setLogin] = useState('');
            const [password, setPassword] = useState('');
            const [user, setUser] = useState(null);
            const [error, setError] = useState('');
            const [loading, setLoading] = useState(false);
            const [initializing, setInitializing] = useState(true);

            // –û–∂–∏–¥–∞–Ω–∏–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ Firebase
            useEffect(() => {
                const checkFirebase = () => {
                    if (window.firebaseReady) {
                        console.log('Firebase –≥–æ—Ç–æ–≤, –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º —Å–ª—É—à–∞—Ç–µ–ª—å...');
                        const { onAuthStateChanged, doc, getDoc } = window.firebaseFunctions;
                        
                        const unsubscribe = onAuthStateChanged(window.firebaseAuth, async (firebaseUser) => {
                            console.log('–°–æ—Å—Ç–æ—è–Ω–∏–µ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏:', firebaseUser ? '–ê–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω' : '–ù–µ—Ç');
                            
                            if (firebaseUser) {
                                try {
                                    const userDoc = await getDoc(doc(window.firebaseDb, 'users', firebaseUser.uid));
                                    
                                    if (userDoc.exists()) {
                                        setUser({
                                            uid: firebaseUser.uid,
                                            login: userDoc.data().login
                                        });
                                        console.log('–î–∞–Ω–Ω—ã–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã:', userDoc.data().login);
                                    }
                                } catch (error) {
                                    console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö:', error);
                                }
                            } else {
                                setUser(null);
                            }
                            setInitializing(false);
                        });
                        
                        return unsubscribe;
                    } else {
                        setTimeout(checkFirebase, 100);
                    }
                };
                
                const unsubscribe = checkFirebase();
                return () => {
                    if (typeof unsubscribe === 'function') {
                        unsubscribe();
                    }
                };
            }, []);

            // –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è —á–µ—Ä–µ–∑ Firebase
            const handleAuth = async () => {
                setError('');
                setLoading(true);

                try {
                    if (!window.firebaseReady) {
                        throw new Error('Firebase –µ—â–µ –Ω–µ –≥–æ—Ç–æ–≤');
                    }

                    if (!login || !password) {
                        throw new Error('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è');
                    }
                    
                    if (login.length < 3) {
                        throw new Error('–õ–æ–≥–∏–Ω –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –Ω–µ –º–µ–Ω–µ–µ 3 —Å–∏–º–≤–æ–ª–æ–≤');
                    }

                    if (password.length < 6) {
                        throw new Error('–ü–∞—Ä–æ–ª—å –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –Ω–µ –º–µ–Ω–µ–µ 6 —Å–∏–º–≤–æ–ª–æ–≤');
                    }

                    const email = loginToEmail(login);
                    const { createUserWithEmailAndPassword, signInWithEmailAndPassword, doc, setDoc, getDoc } = window.firebaseFunctions;

                    if (isLogin) {
                        const userCredential = await signInWithEmailAndPassword(window.firebaseAuth, email, password);
                        const userDoc = await getDoc(doc(window.firebaseDb, 'users', userCredential.user.uid));
                        
                        setUser({
                            uid: userCredential.user.uid,
                            login: userDoc.data().login
                        });
                    } else {
                        const userCredential = await createUserWithEmailAndPassword(window.firebaseAuth, email, password);
                        
                        await setDoc(doc(window.firebaseDb, 'users', userCredential.user.uid), {
                            login: login,
                            createdAt: new Date().toISOString()
                        });
                        
                        setUser({
                            uid: userCredential.user.uid,
                            login: login
                        });
                    }

                    setLoading(false);
                } catch (err) {
                    console.error('–û—à–∏–±–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏:', err);
                    
                    let errorMessage = '–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞';
                    
                    if (err.code === 'auth/email-already-in-use') {
                        errorMessage = '–≠—Ç–æ—Ç –ª–æ–≥–∏–Ω —É–∂–µ –∑–∞–Ω—è—Ç';
                    } else if (err.code === 'auth/wrong-password' || err.code === 'auth/user-not-found') {
                        errorMessage = '–ù–µ–≤–µ—Ä–Ω—ã–π –ª–æ–≥–∏–Ω –∏–ª–∏ –ø–∞—Ä–æ–ª—å';
                    } else if (err.code === 'auth/invalid-credential') {
                        errorMessage = '–ù–µ–≤–µ—Ä–Ω—ã–π –ª–æ–≥–∏–Ω –∏–ª–∏ –ø–∞—Ä–æ–ª—å';
                    } else if (err.message) {
                        errorMessage = err.message;
                    }
                    
                    setError(errorMessage);
                    setLoading(false);
                }
            };

            const handleLogout = async () => {
                try {
                    const { signOut } = window.firebaseFunctions;
                    await signOut(window.firebaseAuth);
                    setUser(null);
                    setLogin('');
                    setPassword('');
                } catch (err) {
                    console.error('–û—à–∏–±–∫–∞ –≤—ã—Ö–æ–¥–∞:', err);
                }
            };

            const handleKeyPress = (e) => {
                if (e.key === 'Enter') {
                    handleAuth();
                }
            };

            // –≠–∫—Ä–∞–Ω –∑–∞–≥—Ä—É–∑–∫–∏
            if (initializing) {
                return (
                    <div className="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 flex items-center justify-center p-4">
                        <div className="bg-white rounded-2xl shadow-xl p-8 w-full max-w-md text-center">
                            <div className="w-16 h-16 bg-indigo-600 rounded-full flex items-center justify-center mx-auto mb-4 animate-pulse">
                                <svg className="w-8 h-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z" />
                                </svg>
                            </div>
                            <p className="text-gray-600 mb-4">–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ Firebase...</p>
                            {error && (
                                <div className="bg-red-50 border border-red-200 rounded-lg p-3 mt-4">
                                    <p className="text-red-800 text-sm">{error}</p>
                                </div>
                            )}
                        </div>
                    </div>
                );
            }

            // –ê–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω
            if (user) {
                return (
                    <div className="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 flex items-center justify-center p-4">
                        <div className="bg-white rounded-2xl shadow-xl p-8 w-full max-w-md">
                            <div className="text-center">
                                <div className="w-20 h-20 bg-indigo-600 rounded-full flex items-center justify-center mx-auto mb-4">
                                    <span className="text-3xl text-white font-bold">
                                        {user.login.charAt(0).toUpperCase()}
                                    </span>
                                </div>
                                <h2 className="text-2xl font-bold text-gray-800 mb-2">
                                    –ü—Ä–∏–≤–µ—Ç, {user.login}!
                                </h2>
                                <p className="text-gray-600 mb-6">
                                    ID: {user.uid.substring(0, 8)}...
                                </p>
                                <div className="bg-green-50 border border-green-200 rounded-lg p-4 mb-6">
                                    <p className="text-green-800 font-medium">
                                        ‚úÖ Firebase –ø–æ–¥–∫–ª—é—á–µ–Ω!
                                    </p>
                                    <p className="text-green-600 text-sm mt-1">
                                        –≠—Ç–∞–ø 2: –ò–Ω—Ç–µ—Ä—Ñ–µ–π—Å —á–∞—Ç–∞ (—Å–ª–µ–¥—É—é—â–∏–π)
                                    </p>
                                </div>
                                <button
                                    onClick={handleLogout}
                                    className="w-full bg-red-500 text-white py-3 rounded-lg font-medium hover:bg-red-600 transition-colors"
                                >
                                    –í—ã–π—Ç–∏
                                </button>
                            </div>
                        </div>
                    </div>
                );
            }

            // –§–æ—Ä–º–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
            return (
                <div className="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 flex items-center justify-center p-4">
                    <div className="bg-white rounded-2xl shadow-xl p-8 w-full max-w-md">
                        <div className="text-center mb-8">
                            <div className="w-16 h-16 bg-indigo-600 rounded-full flex items-center justify-center mx-auto mb-4">
                                <svg className="w-8 h-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z" />
                                </svg>
                            </div>
                            <h1 className="text-3xl font-bold text-gray-800 mb-2">
                                –ú–µ—Å—Å–µ–Ω–¥–∂–µ—Ä
                            </h1>
                            <p className="text-gray-600">
                                {isLogin ? '–í–æ–π–¥–∏—Ç–µ –≤ —Å–≤–æ–π –∞–∫–∫–∞—É–Ω—Ç' : '–°–æ–∑–¥–∞–π—Ç–µ –Ω–æ–≤—ã–π –∞–∫–∫–∞—É–Ω—Ç'}
                            </p>
                        </div>

                        <div className="flex bg-gray-100 rounded-lg p-1 mb-6">
                            <button
                                onClick={() => { setIsLogin(true); setError(''); }}
                                className={`flex-1 py-2 rounded-md font-medium transition-all ${
                                    isLogin ? 'bg-white text-indigo-600 shadow-sm' : 'text-gray-600 hover:text-gray-800'
                                }`}
                            >
                                –í—Ö–æ–¥
                            </button>
                            <button
                                onClick={() => { setIsLogin(false); setError(''); }}
                                className={`flex-1 py-2 rounded-md font-medium transition-all ${
                                    !isLogin ? 'bg-white text-indigo-600 shadow-sm' : 'text-gray-600 hover:text-gray-800'
                                }`}
                            >
                                –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è
                            </button>
                        </div>

                        <div className="space-y-4">
                            <div>
                                <label className="block text-sm font-medium text-gray-700 mb-2">
                                    –õ–æ–≥–∏–Ω
                                </label>
                                <input
                                    type="text"
                                    value={login}
                                    onChange={(e) => setLogin(e.target.value)}
                                    onKeyPress={handleKeyPress}
                                    className="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent outline-none transition-all"
                                    placeholder="–í–∞—à –ª–æ–≥–∏–Ω"
                                />
                            </div>

                            <div>
                                <label className="block text-sm font-medium text-gray-700 mb-2">
                                    –ü–∞—Ä–æ–ª—å
                                </label>
                                <input
                                    type="password"
                                    value={password}
                                    onChange={(e) => setPassword(e.target.value)}
                                    onKeyPress={handleKeyPress}
                                    className="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent outline-none transition-all"
                                    placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"
                                />
                            </div>

                            {error && (
                                <div className="bg-red-50 border border-red-200 rounded-lg p-3">
                                    <p className="text-red-800 text-sm">{error}</p>
                                </div>
                            )}

                            <button
                                onClick={handleAuth}
                                disabled={loading || !window.firebaseReady}
                                className="w-full bg-indigo-600 text-white py-3 rounded-lg font-medium hover:bg-indigo-700 transition-colors disabled:opacity-50 disabled:cursor-not-allowed"
                            >
                                {loading ? '–ó–∞–≥—Ä—É–∑–∫–∞...' : !window.firebaseReady ? '–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è...' : (isLogin ? '–í–æ–π—Ç–∏' : '–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è')}
                            </button>
                        </div>

                        <div className="mt-6 pt-6 border-t border-gray-200">
                            <p className="text-sm text-gray-600 text-center">
                                üìç –≠—Ç–∞–ø 1: Firebase –ø–æ–¥–∫–ª—é—á–µ–Ω ‚úÖ
                            </p>
                        </div>
                    </div>
                </div>
            );
        }

        // –†–µ–Ω–¥–µ—Ä –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
